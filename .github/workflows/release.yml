name: Release
on:
  pull_request:
    types: [closed]
    branches: [main]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  # --- Detect which packages have new versions ---
  detect-changes:
    if: github.head_ref == 'release' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      faderpunk: ${{ steps.check.outputs.faderpunk }}
      faderpunk_version: ${{ steps.check.outputs.faderpunk_version }}
      libfp: ${{ steps.check.outputs.libfp }}
      configurator: ${{ steps.check.outputs.configurator }}
      configurator_minor: ${{ steps.check.outputs.configurator_minor }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - id: check
        run: |
          FP_VERSION=$(grep '^version' faderpunk/Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          LP_VERSION=$(grep '^version' libfp/Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          CF_VERSION=$(jq -r .version configurator/package.json)
          CF_MINOR=$(echo "$CF_VERSION" | cut -d. -f1,2)

          echo "faderpunk_version=$FP_VERSION" >> $GITHUB_OUTPUT
          echo "faderpunk=$(git tag -l "faderpunk/v$FP_VERSION" | grep -q . && echo 'false' || echo 'true')" >> $GITHUB_OUTPUT
          echo "libfp=$(git tag -l "libfp/v$LP_VERSION" | grep -q . && echo 'false' || echo 'true')" >> $GITHUB_OUTPUT
          echo "configurator=$(git tag -l "configurator/v$CF_VERSION" | grep -q . && echo 'false' || echo 'true')" >> $GITHUB_OUTPUT
          echo "configurator_minor=$CF_MINOR" >> $GITHUB_OUTPUT

  # --- Build picotool (cached) ---
  build-picotool:
    needs: detect-changes
    if: needs.detect-changes.outputs.faderpunk == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential pkg-config libusb-1.0-0-dev cmake git
      - name: Clone pico-sdk repository
        run: git clone --branch master https://github.com/raspberrypi/pico-sdk.git
      - name: Clone picotool repository
        run: git clone --branch master https://github.com/raspberrypi/picotool.git
      - name: Get Git commit hashes for caching
        id: hashes
        run: |
          picotool_hash=$(git -C picotool rev-parse HEAD)
          pico_sdk_hash=$(git -C pico-sdk rev-parse HEAD)
          echo "picotool_hash=${picotool_hash}" >> $GITHUB_ENV
          echo "pico_sdk_hash=${pico_sdk_hash}" >> $GITHUB_ENV
      - name: Cache picotool build outputs
        uses: actions/cache@v4
        with:
          path: picotool/build
          key: ${{ runner.os }}-picotool-${{ env.picotool_hash }}-${{ env.pico_sdk_hash }}
      - name: Check if picotool already exists
        id: check_picotool
        run: |
          if [ -f picotool/build/picotool ]; then
            echo "picotool already exists. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi
      - name: Initialize pico-sdk submodules
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: |
          cd pico-sdk
          git submodule update --init lib/mbedtls
      - name: Set PICO_SDK_PATH
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: echo "PICO_SDK_PATH=${{ github.workspace }}/pico-sdk" >> $GITHUB_ENV
      - name: Build picotool
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: |
          cd picotool
          mkdir -p build
          cd build
          cmake ..
          make
      - name: Upload picotool artifact
        uses: actions/upload-artifact@v4
        with:
          name: picotool-artifact
          path: picotool/build/picotool

  # --- Build firmware ---
  build-firmware:
    needs: detect-changes
    if: needs.detect-changes.outputs.faderpunk == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Install System Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get clean && sudo apt-get update
          sudo apt-get install -y libudev-dev
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: thumbv8m.main-none-eabihf
      - run: cargo install flip-link
      - run: cargo build --bin faderpunk --release --target thumbv8m.main-none-eabihf
      - name: Upload firmware build artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-artifact
          path: target/thumbv8m.main-none-eabihf/release/faderpunk

  # --- Package firmware (ELF + UF2) ---
  package-firmware:
    needs: [detect-changes, build-firmware, build-picotool]
    if: needs.detect-changes.outputs.faderpunk == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download picotool artifact
        uses: actions/download-artifact@v7
        with:
          name: picotool-artifact
          path: picotool_executable
      - name: Download firmware artifact
        uses: actions/download-artifact@v7
        with:
          name: firmware-artifact
          path: firmware_build
      - name: Prepare release files
        run: |
          mkdir -p artifacts
          cp firmware_build/faderpunk artifacts/faderpunk.elf
          chmod +x picotool_executable/picotool
          VERSION="v${{ needs.detect-changes.outputs.faderpunk_version }}"
          picotool_executable/picotool uf2 convert artifacts/faderpunk.elf artifacts/faderpunk-${VERSION}.uf2
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-firmware
          path: artifacts

  # --- Build configurator ---
  build-configurator:
    needs: detect-changes
    if: needs.detect-changes.outputs.configurator == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Setup rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Install dependencies (configurator)
        run: pnpm install --frozen-lockfile
        working-directory: ./configurator
      - name: Generate postcard bindings (for configurator)
        run: ./gen-bindings.sh
      - name: Build configurator
        run: pnpm run build
        working-directory: ./configurator
        env:
          BASE_URL: /${{ needs.detect-changes.outputs.configurator_minor }}/
      - name: Create configurator release package
        run: |
          mkdir -p artifacts
          cd configurator/dist
          zip -r ../../artifacts/configurator.zip .
      - name: Upload configurator release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-configurator
          path: artifacts
      - name: Build landing page
        run: pnpm run build:landing
        working-directory: ./configurator
      - name: Upload configurator artifact for GitHub Pages
        uses: actions/upload-artifact@v4
        with:
          name: configurator-pages-artifact
          path: configurator/dist
      - name: Upload landing page artifact for GitHub Pages
        uses: actions/upload-artifact@v4
        with:
          name: landing-pages-artifact
          path: configurator/dist-landing

  # --- Create GitHub releases + upload assets ---
  release:
    needs: [detect-changes, package-firmware, build-configurator]
    if: always() && needs.detect-changes.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Download firmware artifacts
        if: needs.package-firmware.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: release-artifacts-firmware
          path: artifacts
      - name: Download configurator artifacts
        if: needs.build-configurator.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: release-artifacts-configurator
          path: artifacts
      - uses: knope-dev/action@v2.1.0
        with:
          version: 0.22.2
      - run: knope release --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --- Deploy configurator to GitHub Pages ---
  deploy-configurator:
    needs: [detect-changes, build-configurator]
    if: needs.detect-changes.outputs.configurator == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages
      - name: Download configurator artifact
        uses: actions/download-artifact@v7
        with:
          name: configurator-pages-artifact
          path: configurator-dist
      - name: Download landing page artifact
        uses: actions/download-artifact@v7
        with:
          name: landing-pages-artifact
          path: landing-dist
      - name: Deploy to versioned folder and root
        run: |
          VERSION="${{ needs.detect-changes.outputs.configurator_minor }}"

          # Create/update versioned directory
          mkdir -p gh-pages/${VERSION}
          rm -rf gh-pages/${VERSION}/*
          cp -r configurator-dist/* gh-pages/${VERSION}/
          rm -f gh-pages/${VERSION}/CNAME

          # Preserve CNAME
          mkdir -p temp-preserve
          cp -f gh-pages/CNAME temp-preserve/CNAME 2>/dev/null || true

          # Clear root except versioned folders, beta, and .git
          find gh-pages -mindepth 1 -maxdepth 1 -type f -exec rm {} \;
          find gh-pages -mindepth 1 -maxdepth 1 -type d \
            ! -name '[0-9]*.[0-9]*' ! -name 'beta' ! -name '.git' \
            ! -name 'img' ! -name 'fonts' -exec rm -rf {} \;

          # Deploy landing page (built by Vite with version already injected)
          cp -r landing-dist/* gh-pages/

          # Copy assets to root (shared across all versions)
          mkdir -p gh-pages/img gh-pages/fonts
          cp -r configurator-dist/img/* gh-pages/img/ 2>/dev/null || true
          cp -r configurator-dist/fonts/* gh-pages/fonts/ 2>/dev/null || true

          # Restore CNAME
          cp temp-preserve/CNAME gh-pages/CNAME 2>/dev/null || true

          cd gh-pages
          git checkout gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy configurator v${VERSION} and update landing page" || echo "No changes"
          git push origin gh-pages

  # --- Publish libfp to crates.io ---
  publish-libfp:
    needs: [detect-changes, release]
    if: needs.detect-changes.outputs.libfp == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
      - run: cargo publish --package libfp
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
