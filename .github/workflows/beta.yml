name: Beta Release
on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  pages: write

jobs:
  prepare-beta:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.commit.outputs.sha }}
      faderpunk_version: ${{ steps.commit.outputs.faderpunk_version }}
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - uses: knope-dev/action@v2.1.0
        with:
          version: 0.22.2
      - name: Prepare beta release
        run: knope prepare-beta --verbose
      - name: Commit and push
        id: commit
        run: |
          git add -A
          git commit -m "chore: beta release"
          git push
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "faderpunk_version=$(grep '^version' faderpunk/Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')" >> $GITHUB_OUTPUT

  build-picotool:
    needs: prepare-beta
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare-beta.outputs.sha }}
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential pkg-config libusb-1.0-0-dev cmake git
      - name: Clone pico-sdk repository
        run: git clone --branch master https://github.com/raspberrypi/pico-sdk.git
      - name: Clone picotool repository
        run: git clone --branch master https://github.com/raspberrypi/picotool.git
      - name: Get Git commit hashes for caching
        id: hashes
        run: |
          picotool_hash=$(git -C picotool rev-parse HEAD)
          pico_sdk_hash=$(git -C pico-sdk rev-parse HEAD)
          echo "picotool_hash=${picotool_hash}" >> $GITHUB_ENV
          echo "pico_sdk_hash=${pico_sdk_hash}" >> $GITHUB_ENV
      - name: Cache picotool build outputs
        uses: actions/cache@v4
        with:
          path: picotool/build
          key: ${{ runner.os }}-picotool-${{ env.picotool_hash }}-${{ env.pico_sdk_hash }}
      - name: Check if picotool already exists
        id: check_picotool
        run: |
          if [ -f picotool/build/picotool ]; then
            echo "picotool already exists. Skipping build."
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi
      - name: Initialize pico-sdk submodules
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: |
          cd pico-sdk
          git submodule update --init lib/mbedtls
      - name: Set PICO_SDK_PATH
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: echo "PICO_SDK_PATH=${{ github.workspace }}/pico-sdk" >> $GITHUB_ENV
      - name: Build picotool
        if: steps.check_picotool.outputs.skip_build == 'false'
        run: |
          cd picotool
          mkdir -p build
          cd build
          cmake ..
          make
      - name: Upload picotool artifact
        uses: actions/upload-artifact@v4
        with:
          name: picotool-artifact
          path: picotool/build/picotool

  build-firmware:
    needs: prepare-beta
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare-beta.outputs.sha }}
      - name: Install System Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get clean && sudo apt-get update
          sudo apt-get install -y libudev-dev
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          targets: thumbv8m.main-none-eabihf
      - run: cargo install flip-link
      - run: cargo build --bin faderpunk --release --target thumbv8m.main-none-eabihf
      - name: Upload firmware build artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-artifact
          path: target/thumbv8m.main-none-eabihf/release/faderpunk

  package-firmware:
    needs: [prepare-beta, build-firmware, build-picotool]
    runs-on: ubuntu-latest
    steps:
      - name: Download picotool artifact
        uses: actions/download-artifact@v7
        with:
          name: picotool-artifact
          path: picotool_executable
      - name: Download firmware artifact
        uses: actions/download-artifact@v7
        with:
          name: firmware-artifact
          path: firmware_build
      - name: Prepare release files
        run: |
          mkdir -p artifacts
          cp firmware_build/faderpunk artifacts/faderpunk.elf
          chmod +x picotool_executable/picotool
          VERSION="v${{ needs.prepare-beta.outputs.faderpunk_version }}"
          picotool_executable/picotool uf2 convert artifacts/faderpunk.elf artifacts/faderpunk-${VERSION}.uf2
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-firmware
          path: artifacts

  build-configurator:
    needs: prepare-beta
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare-beta.outputs.sha }}
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Setup rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Install dependencies (configurator)
        run: pnpm install --frozen-lockfile
        working-directory: ./configurator
      - name: Generate postcard bindings (for configurator)
        run: ./gen-bindings.sh
      - name: Build configurator with beta base path
        run: pnpm run build
        working-directory: ./configurator
        env:
          BASE_URL: /beta/
          RELEASE_CHANNEL: beta
      - name: Create configurator release package
        run: |
          mkdir -p artifacts
          cd configurator/dist
          zip -r ../../artifacts/configurator.zip .
      - name: Upload configurator release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-configurator
          path: artifacts
      - name: Upload configurator artifact for GitHub Pages
        uses: actions/upload-artifact@v4
        with:
          name: configurator-pages-artifact
          path: configurator/dist

  release:
    needs: [prepare-beta, package-firmware, build-configurator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare-beta.outputs.sha }}
          fetch-depth: 0
      - name: Download firmware artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-artifacts-firmware
          path: artifacts
      - name: Download configurator artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-artifacts-configurator
          path: artifacts
      - uses: knope-dev/action@v2.1.0
        with:
          version: 0.22.2
      - run: knope release --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-beta-configurator:
    needs: [prepare-beta, build-configurator]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ needs.prepare-beta.outputs.sha }}
          fetch-depth: 0
      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages
      - name: Download configurator artifact
        uses: actions/download-artifact@v7
        with:
          name: configurator-pages-artifact
          path: configurator-dist
      - name: Deploy to /beta subfolder
        run: |
          mkdir -p gh-pages/beta
          rm -rf gh-pages/beta/*
          cp -r configurator-dist/* gh-pages/beta/
          rm -f gh-pages/beta/CNAME
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add beta/
          git commit -m "Deploy beta configurator" || echo "No changes to commit"
          git push
